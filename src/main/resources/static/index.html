<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>üéô Voice Assistant Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f0f2f5;
            color: #333;
        }
        h1 {
            text-align: center;
            color: #4a90e2;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            font-size: 16px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            transition: background 0.2s;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        #connectBtn { background: #4caf50; color: white; }
        #sendBtn { background: #2196f3; color: white; }
        #stopBtn { background: #f44336; color: white; }
        #status { font-weight: bold; margin-top: 10px; }
        #log {
            border: 1px solid #ccc;
            background: white;
            height: 200px;
            overflow-y: scroll;
            padding: 10px;
            margin-top: 20px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 14px;
        }
        #audioBar {
            width: 100%;
            height: 20px;
            background: #eee;
            margin-top: 10px;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }
        #audioProgress {
            height: 100%;
            width: 0%;
            background: #4caf50;
            transition: width 0.1s linear;
        }
    </style>
</head>
<body>
<h1>üéô Voice Assistant WebSocket Test</h1>

<div>
    <button id="connectBtn">Connect</button>
    <button id="sendBtn" disabled>Send Audio Chunk</button>
    <button id="stopBtn" disabled>Stop Audio</button>
</div>

<p id="status">Status: Disconnected</p>

<div id="audioBar">
    <div id="audioProgress"></div>
</div>

<div id="log"></div>

<script>
    let ws;
    let audioContext;
    let currentSource = null;
    let animationId = null;

    const connectBtn = document.getElementById("connectBtn");
    const sendBtn = document.getElementById("sendBtn");
    const stopBtn = document.getElementById("stopBtn");
    const statusEl = document.getElementById("status");
    const logEl = document.getElementById("log");
    const audioProgress = document.getElementById("audioProgress");

    function log(message) {
        const time = new Date().toLocaleTimeString();
        logEl.innerHTML += `[${time}] ${message}<br>`;
        logEl.scrollTop = logEl.scrollHeight;
    }

    connectBtn.addEventListener("click", async () => {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        await audioContext.resume();

        ws = new WebSocket("ws://localhost:8080/ws/audio");
        ws.binaryType = "arraybuffer";

        ws.onopen = () => {
            log("‚úÖ Connected to WebSocket");
            statusEl.innerText = "Status: Connected";
            sendBtn.disabled = false;
            stopBtn.disabled = false;
        };

        ws.onclose = () => {
            log("‚ùå WebSocket closed");
            statusEl.innerText = "Status: Disconnected";
            sendBtn.disabled = true;
            stopBtn.disabled = true;
            resetAudioBar();
        };

        ws.onerror = (e) => {
            log("‚ùå WebSocket error: " + e);
        };

        ws.onmessage = async (event) => {
            if (!(event.data instanceof ArrayBuffer)) {
                log("‚ö†Ô∏è Received non-binary message: " + event.data);
                return;
            }
            log("üîä Received audio bytes: " + event.data.byteLength);
            playAudio(event.data);
        };
    });

    sendBtn.addEventListener("click", () => {
        if (!ws || ws.readyState !== WebSocket.OPEN) {
            alert("WebSocket is not connected!");
            return;
        }
        const dummyBytes = new Uint8Array([1,2,3,4,5,6]); // backend ignores for mock
        ws.send(dummyBytes);
        log("üì§ Sent dummy audio chunk");
    });

    stopBtn.addEventListener("click", () => {
        if (currentSource) {
            currentSource.stop();
            currentSource.disconnect();
            currentSource = null;
            log("‚èπ Stopped audio playback");
            resetAudioBar();
        }
    });

    async function playAudio(arrayBuffer) {
        try {
            if (currentSource) {
                currentSource.stop();
                currentSource.disconnect();
            }

            const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);

            const source = audioContext.createBufferSource();
            source.buffer = audioBuffer;
            source.connect(audioContext.destination);
            source.start(0);

            currentSource = source;
            log("‚ñ∂Ô∏è Playing audio");

            const startTime = audioContext.currentTime;
            const duration = audioBuffer.duration;

            cancelAnimationFrame(animationId);

            function updateProgress() {
                const elapsed = audioContext.currentTime - startTime;
                audioProgress.style.width = Math.min((elapsed / duration) * 100, 100) + "%";
                if (elapsed < duration) {
                    animationId = requestAnimationFrame(updateProgress);
                }
            }
            updateProgress();

            source.onended = () => {
                currentSource = null;
                resetAudioBar();
                log("‚úÖ Audio finished");
            };
        } catch (err) {
            log("‚ùå Failed to play audio: " + err);
        }
    }

    function resetAudioBar() {
        audioProgress.style.width = "0%";
        cancelAnimationFrame(animationId);
    }
</script>
</body>
</html>